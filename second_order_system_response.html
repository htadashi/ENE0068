<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Sistema de Segunda Ordem Interativo</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .plot-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: flex-start;
        }
        .unit-circle-plot {
            flex: 1 1 300px;  
            max-width: 30%;
            aspect-ratio: 1 / 1;
        }
        .step-response-plot {
            flex: 1 1 300px;
            max-width: 90%;
            aspect-ratio: 16 / 9;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            font-family: Arial, sans-serif;
        }
        .control {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #transfer-function {
            text-align: center; 
            margin-top: 10px; 
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body>

<h2>Resposta de um sistema de segunda ordem</h2>

<div class="plot-container">
    <div id="unit-circle" class="unit-circle-plot"></div>
    <div>
        <div id="step-response" class="step-response-plot"></div>
        <div id="transfer-function"></div>
    </div>
</div>

<div class="controls">
    <div class="control">
        <label for="responseType">Tipo de Resposta:</label>
        <select id="responseType">
            <option value="step">Resposta ao Degrau</option>
            <option value="impulse">Resposta ao Impulso</option>
            <option value="sine">Resposta ao Seno</option>
        </select>
    </div>

    <div class="control">
        <label for="rSlider">Norma (r): <span id="rValue">0.8</span></label>
        <input type="range" id="rSlider" min="0" max="1.2" step="0.01" value="0.8">
    </div>

    <div class="control">
        <label for="thetaSlider">Argumento (θ): <span id="thetaValue">0.79</span> rad</label>
        <input type="range" id="thetaSlider" min="0" max="3.14" step="0.01" value="0.79">
    </div>
</div>

<script>
    const N = 30;
    const unitCirclePoints = 300;
    const thetaCircle = Array.from({length: unitCirclePoints}, (_, i) => 2 * Math.PI * i / unitCirclePoints);
    const unitCircleX = thetaCircle.map(t => Math.cos(t));
    const unitCircleY = thetaCircle.map(t => Math.sin(t));

    let r = 0.8;
    let theta = Math.PI / 4;
    let responseType = 'step';

    const unitCircleTrace = {
        x: unitCircleX,
        y: unitCircleY,
        mode: 'lines',
        name: 'Círculo Unitário',
        line: { dash: 'dot', color: 'black' }
    };

    const polesTrace = {
        x: [],
        y: [],
        mode: 'markers+text',
        name: 'Polos',
        marker: { size: 12, color: 'red', symbol: 'x' },
        text: ['p1', 'p2'],
        textposition: 'top right'
    };

    const unitLayout = {
        title: 'Polos no Plano Complexo',
        xaxis: { title: 'Parte Real', range: [-1.2, 1.2], zeroline: true },
        yaxis: { title: 'Parte Imaginária', range: [-1.2, 1.2], zeroline: true, scaleanchor: 'x' },
        showlegend: true,
        margin: { t: 50 }
    };

    const stepResponseTrace = {
        x: [],
        y: [],
        mode: 'lines+markers',
        name: 'Resposta',
        line: { color: 'blue' }
    };

    const stepLayout = {
        title: 'Resposta do Sistema',
        xaxis: { title: 'Amostra n' },
        yaxis: { title: 'Amplitude de y[n]' },
        margin: { t: 50 }
    };

    Plotly.newPlot('unit-circle', [unitCircleTrace, polesTrace], unitLayout);
    Plotly.newPlot('step-response', [stepResponseTrace], stepLayout);

    function updatePlots() {
        document.getElementById('rValue').innerText = r.toFixed(2);
        document.getElementById('thetaValue').innerText = theta.toFixed(2);

        const p1 = { re: r * Math.cos(theta), im: r * Math.sin(theta) };
        const p2 = { re: r * Math.cos(-theta), im: r * Math.sin(-theta) };

        polesTrace.x = [p1.re, p2.re];
        polesTrace.y = [p1.im, p2.im];

        Plotly.react('unit-circle', [unitCircleTrace, polesTrace], unitLayout);

        const a = [1, -2 * r * Math.cos(theta), r ** 2];
        const b = [1];

        let u = Array(N).fill(0);
        switch(responseType) {
            case 'step':
                u = Array(N).fill(1);
                break;
            case 'impulse':
                u[0] = 1;
                break;
            case 'sine':
                const freq = 0.1;
                u = Array.from({length: N}, (_, n) => Math.sin(2 * Math.PI * freq * n));
                break;
        }

        const y = Array(N).fill(0);
        for (let n = 0; n < N; n++) {
            const u_n = u[n];
            const y_n1 = n >= 1 ? y[n - 1] : 0;
            const y_n2 = n >= 2 ? y[n - 2] : 0;
            y[n] = (b[0] * u_n - a[1] * y_n1 - a[2] * y_n2) / a[0];
        }

        const nSamples = Array.from({ length: N }, (_, i) => i);

        stepResponseTrace.x = nSamples;
        stepResponseTrace.y = y;

        Plotly.react('step-response', [stepResponseTrace], stepLayout);

        const tfDiv = document.getElementById('transfer-function');
        const tfLatex = `H(z) = \\frac{1}{1 - 2(${r.toFixed(2)})\\cos(${theta.toFixed(2)})z^{-1} + (${r.toFixed(2)})^2 z^{-2}}`;
        tfDiv.innerHTML = `Função de Transferência: <br> $$${tfLatex}$$`;
        if (window.MathJax) {
            MathJax.typesetPromise([tfDiv]);
        }
    }

    document.getElementById('rSlider').addEventListener('input', function() {
        r = parseFloat(this.value);
        updatePlots();
    });

    document.getElementById('thetaSlider').addEventListener('input', function() {
        theta = parseFloat(this.value);
        updatePlots();
    });

    document.getElementById('responseType').addEventListener('change', function() {
        responseType = this.value;
        updatePlots();
    });

    updatePlots();
</script>

</body>
</html>
